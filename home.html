<!DOCTYPE html>
<html lang="he">

<head>
    <meta charset="UTF-8">
    <title>×“×£ ×”×‘×™×ª</title>
    <link rel="stylesheet" href="style2.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body>
    <header class="top-bar">
        <div class="logo-right">
            <img src="images/cooking.png" alt="×œ×•×’×•" class="logo" />
        </div>

        <div class="add-btn">
            <button class="add-recipe-btn" onclick="window.location.href='add-recipe.html'">â• ×”×•×¡×£ ××ª×›×•×Ÿ</button>
        </div>
        <div class="search-center">
            <div style="display: flex; gap: 10px; align-items: center; position: relative;">
                <div style="position: relative; width: 100%;">
                    <input type="text" id="searchInput" placeholder="×—×¤×© ××ª×›×•×Ÿ..." onkeydown="handleSearchKey(event)">
                    <div id="recipeSuggestions" class="autocomplete-suggestions"></div>
                </div>
                <button class="home-recipe-btn hidden" id="backToAllBtn" onclick="handleBackToAll()">ğŸ  ×¨××©×™</button>
            </div>
        </div>

        <div class="user-left">
            <div id="userInfo">
                <img src="https://cdn-icons-png.flaticon.com/512/1144/1144760.png" alt="User Icon">
                <span id="userEmail">×©×œ×•×</span>
                <div id="logoutMenu" class="hidden">
                    <button id="logoutBtn" class="exit">ğŸšª ×™×¦×™××”</button>
                </div>
            </div>
        </div>
    </header>



    <div id="content"></div>


    <!-- ×›××Ÿ ×™×•×¤×™×¢×• ×”××ª×›×•× ×™× -->
    <div id="recipeList" style="padding: 30px;"></div>
    <div class="pagination" id="paginationContainer"></div>




    <p id="error"></p>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        const SUPABASE_URL = 'https://izpbbjhikbbbyahxzhkg.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml6cGJiamhpa2JiYnlhaHh6aGtnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgxOTMxMDUsImV4cCI6MjA2Mzc2OTEwNX0.Gv0WaUlkUAW1qBNEaaXDCWWpwWgbvBTya8KQzFhx08s'; // ×©×™× ××ª ×”××¤×ª×— ×”××œ× ×©×œ×š ×¤×”

        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY, {
            auth: {
                persistSession: true,
                autoRefreshToken: true
            },
            global: {
                headers: {
                    apikey: SUPABASE_KEY
                }
            }
        });


        // ×”×¦×’×ª ×ª×¤×¨×™×˜ ×™×¦×™××” ×‘×œ×—×™×¦×” ×¢×œ ×”××–×•×¨ ×©×œ ×”××©×ª××©
        document.getElementById("userInfo").addEventListener("click", () => {
            const menu = document.getElementById("logoutMenu");
            menu.classList.toggle("hidden");
        });


        window.handleSearchKey = async function (e) {
            if (e.key !== "Enter") return;

            const query = e.target.value.trim().toLowerCase();
            const list = document.getElementById("recipeList");
            list.innerHTML = "";

            const { data, error } = await supabase.from("recipes").select("*");

            if (error) {
                console.error("×©×’×™××” ×‘×§×‘×œ×ª × ×ª×•× ×™× ××”×©×¨×ª:", error);
                return;
            }

            const approved = data.filter(r => r.is_approved === true);
            const results = approved.filter(r => (r.title || "").toLowerCase().includes(query));

            const backBtn = document.getElementById("backToAllBtn");
            if (backBtn) backBtn.classList.remove("hidden");

            if (results.length === 0) {
                list.innerHTML = `<p id="noResultsMessage" style="color:#152ebd;  font-weight: bolder; font-size: xx-large; margin-top:15px;">×œ× × ××¦× ×”××ª×›×•×Ÿ!</p>`;
                return;
            }

            results.forEach(recipe => list.appendChild(createRecipeElement(recipe)));
            applyDifficultyColors();

        };


        function createRecipeElement(recipe) {
            const container = document.createElement("div");
            container.classList.add("recipe-container");

            const createdAt = new Date(recipe.created_at);
            const formattedDate = createdAt.toLocaleDateString("he-IL", {
                year: "numeric",
                month: "long",
                day: "numeric"
            });

            const previewHTML = `
  <button class="recipe-button">
    <div>${recipe.title || "×œ×œ× ×›×•×ª×¨×ª"}</div>
    <div style="font-size: 0.8rem; color: #666;">ğŸ“… ×”×•×¢×œ×” ×‘×ª××¨×™×š: ${formattedDate}</div>
  </button>
`;
            const fullHTML = `
<div class="recipe-content">
    <div class="recipe-text">
                <div><strong>ğŸ‘¤ ×”×©×•×œ×—:</strong><div>${recipe.author || "×œ× ×¦×•×™×™×Ÿ"}</div></div> <!-- âœ… ×—×“×© -->
        <div><strong>×›×•×ª×¨×ª:</strong><div class="recipe-title">${recipe.title || "×œ×œ× ×›×•×ª×¨×ª"}</div></div>
        <div><strong>×ª×™××•×¨:</strong><div class="recipe-description">${recipe.description || "××™×Ÿ ×ª×™××•×¨ ×œ××ª×›×•×Ÿ"}</div></div>
        <div><strong>××¦×¨×›×™×:</strong><div>${recipe.ingredients || "×œ× ×¦×•×™×™× ×• ××¦×¨×›×™×"}</div></div>
        <div><strong>××•×¤×Ÿ ×”×›× ×”:</strong><div>${recipe.instructions || "××™×Ÿ ×”×•×¨××•×ª ×”×›× ×”"}</div></div>
        <div><strong>×¨××ª ×§×•×©×™:</strong><br><div class="difficulty">${recipe.difficulty || "×œ× ×¦×•×™×™×Ÿ"}</div></div>
        <div><strong>â±ï¸ ×–××Ÿ ×”×›× ×”:</strong><div>${recipe.prep_time_range || "×œ× ×¦×•×™×™×Ÿ"}</div></div>
        <div><strong>ğŸ“ ×§×˜×’×•×¨×™×”:</strong><div>${recipe.category || "×œ× ×¦×•×™× ×” ×§×˜×’×•×¨×™×”"}</div></div>
    </div>
    <div class="recipe-images">
        ${recipe.image1_url ? `<img src="${recipe.image1_url}" class="recipe-img">` : ""}
        ${recipe.image2_url ? `<img src="${recipe.image2_url}" class="recipe-img">` : ""}
        ${recipe.image3_url ? `<img src="${recipe.image3_url}" class="recipe-img">` : ""}
    </div>
</div>
`;





            const preview = document.createElement("div");
            preview.classList.add("recipe-preview");
            preview.innerHTML = previewHTML;

            const full = document.createElement("div");
            full.classList.add("recipe-full");
            full.innerHTML = fullHTML;

            container.appendChild(preview);
            container.appendChild(full);

            container.addEventListener("click", () => {
                // ×¡×’×•×¨ ××ª×›×•× ×™× ×¤×ª×•×—×™× ××—×¨×™×
                document.querySelectorAll(".recipe-full.open").forEach(el => {
                    if (el !== full) el.classList.remove("open");
                });
                full.classList.toggle("open");
            });

            return container;
        }


        let currentPage = 1;
        const recipesPerPage = 10;

        async function loadRecipes(page = 1) {
            currentPage = page;

            const from = (page - 1) * recipesPerPage;
            const to = from + recipesPerPage - 1;

            const { data, error } = await supabase
                .from("recipes")
                .select("*")
                .order("created_at", { ascending: false }) // âœ… ××™×•×Ÿ ××”×—×“×© ×œ×™×©×Ÿ
                .range(from, to); // âœ… ×“×¤×“×•×£ ×œ×¤×™ ×¢××•×“×™×

            if (error) {
                console.error("âŒ ×©×’×™××” ×‘×§×‘×œ×ª ××ª×›×•× ×™×:", error);
                return;
            }

            const approved = data.filter(recipe => recipe.is_approved === true);
            const list = document.getElementById("recipeList");
            list.innerHTML = "";

            if (approved.length === 0) {
                list.innerHTML = "<p>âš ï¸ ××™×Ÿ ×¢×“×™×™×Ÿ ××ª×›×•× ×™× ×××•×©×¨×™× ×œ×”×¦×’×”.</p>";
                return;
            }

            approved.forEach(recipe => list.appendChild(createRecipeElement(recipe)));

            renderPagination(approved.length);
            applyDifficultyColors();
        }




        function renderPagination(totalRecipes) {
            const totalPages = Math.ceil(totalRecipes / recipesPerPage);
            const list = document.getElementById("recipeList");

            const pagination = document.createElement("div");
            pagination.className = "pagination";

            for (let i = 1; i <= totalPages; i++) {
                const btn = document.createElement("button");
                btn.textContent = i;
                btn.className = i === currentPage ? "active" : "";
                btn.onclick = () => loadRecipes(i);
                pagination.appendChild(btn);
            }

            list.appendChild(pagination);
        }


        async function checkSession() {
            const { data: { session } } = await supabase.auth.getSession();

            if (!session) {
                alert("×”×—×™×‘×•×¨ ×©×œ×š ×¤×’ ×ª×•×§×£ ××• ×©××™× ×š ××—×•×‘×¨");
                window.location.href = "index.html";
                return;
            }

            const fullEmail = session.user.email;
            const shortEmail = fullEmail.length > 8
                ? fullEmail.substring(0, 5) + "..."
                : fullEmail;

            document.getElementById("userEmail").innerHTML = `×©×œ×•×, <span dir="ltr">${shortEmail}</span>`;
            console.log("××©×ª××© ××—×•×‘×¨:", session.user.email);

            // â¬…ï¸ ×§×¨×™××” ××—×¨×™ ×©×”×¤×•× ×§×¦×™×” ×§×™×™××ª
            loadRecipes();
        }

        checkSession();

        document.getElementById("logoutBtn").addEventListener("click", async () => {
            await supabase.auth.signOut();
            localStorage.clear(); // ××•×—×§ ×›×œ ××” ×©× ×©××¨
            sessionStorage.clear(); // ×× ×”×©×ª××©×ª ×’× ×‘×–×”
            window.location.href = "index.html";
        });

        window.handleBackToAll = function () {
            document.getElementById("searchInput").value = "";
            const backBtn = document.getElementById("backToAllBtn");
            if (backBtn) backBtn.classList.add("hidden");
            loadRecipes();
        };

        const recipeInput = document.getElementById("searchInput");
        const suggestionBox = document.getElementById("recipeSuggestions");

        recipeInput.addEventListener("input", async () => {
            const query = recipeInput.value.trim().toLowerCase();
            suggestionBox.innerHTML = "";

            if (query.length < 1) {
                suggestionBox.style.display = "none";
                return;
            }

            const { data, error } = await supabase
                .from("recipes")
                .select("title, is_approved");

            if (error || !data) {
                suggestionBox.style.display = "none";
                return;
            }

            const approvedTitles = data
                .filter(r => r.is_approved)
                .map(r => r.title)
                .filter(Boolean)
                .filter(title => title.toLowerCase().startsWith(query))
                .slice(0, 10); // ×¢×“ 10 ×”×¦×¢×•×ª

            if (approvedTitles.length === 0) {
                suggestionBox.style.display = "none";
                return;
            }

            approvedTitles.forEach(title => {
                const item = document.createElement("div");
                item.className = "recipe-suggestion-item";
                item.textContent = title;

                item.addEventListener("click", () => {
                    recipeInput.value = title;
                    suggestionBox.style.display = "none";
                    const enterEvent = new KeyboardEvent("keydown", { key: "Enter" });
                    recipeInput.dispatchEvent(enterEvent);
                });

                suggestionBox.appendChild(item);
            });

            suggestionBox.style.display = "block";
        });

        document.addEventListener("click", function (e) {
            if (!e.target.closest("#searchInput") && !e.target.closest("#recipeSuggestions")) {
                suggestionBox.style.display = "none";
            }
        });

        document.addEventListener("click", function (event) {
            const userInfo = document.getElementById("userInfo");
            const logoutMenu = document.getElementById("logoutMenu");

            // ×× × ×œ×—×¥ ×‘×ª×•×š ×”××–×•×¨ ×©×œ ×”××©×ª××© ××• ×›×¤×ª×•×¨ ×”×™×¦×™××” â€“ ××œ ×ª×¡×’×•×¨
            if (userInfo.contains(event.target) || logoutMenu.contains(event.target)) {
                return;
            }

            // ××—×¨×ª â€“ ×ª×¡×’×•×¨
            logoutMenu.classList.add("hidden");
        });

        function applyDifficultyColors() {
            document.querySelectorAll(".difficulty").forEach(div => {
                const text = div.textContent.trim();
                div.classList.remove("green", "blue", "red"); // × ×§×” ×§×•×“×
                if (text === "×§×œ") div.classList.add("green");
                if (text === "×‘×™× ×•× ×™") div.classList.add("blue");
                if (text === "×§×©×”") div.classList.add("red");
            });
        }

    </script>

</body>

</html>
